name: GDIndex Scheduled Scan

on:
  schedule:
    # Run at 00:00 and 10:00 UTC (07:00 and 17:00 GMT+7)
    - cron: '0 0,10 * * *'
  workflow_dispatch:
    inputs:
      url:
        description: 'Target GDIndex URL (Leave empty to use Secret)'
        required: false
      type:
        description: 'Type (auto, movie, tv)'
        required: false
        default: 'auto'

jobs:
  scan-gdindex:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 hours max

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r cloudflare-backend/admin_tools/requirements.txt

    - name: Restore/Save GDID Cache
      uses: actions/cache@v3
      with:
        path: gdids_cache.json
        key: gdid-cache-${{ github.run_id }}
        restore-keys: |
          gdid-cache-

    - name: Run Scan Script
      env:
        # Secrets
        ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
        TMDB_KEY: ${{ secrets.TMDB_KEY }}
        GDINDEX_URL: ${{ secrets.GDINDEX_URL }}
        GD_USER: ${{ secrets.GD_USER }}
        GD_PASS: ${{ secrets.GD_PASS }}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        FCM_KEY: ${{ secrets.FCM_KEY }}
        
        # Inputs (Manual Override)
        INPUT_URL: ${{ github.event.inputs.url }}
        INPUT_TYPE: ${{ github.event.inputs.type }}
      run: |
        if [ ! -z "$INPUT_URL" ]; then
          # --- MANUAL TRIGGER (Single URL) ---
          TARGET_TYPE="${INPUT_TYPE:-auto}"
          echo ">>> [MANUAL] Starting scan: $INPUT_URL [Type: $TARGET_TYPE]"
          
          python cloudflare-backend/admin_tools/import_gdindex.py \
            --url "$INPUT_URL" \
            --admin-key "$ADMIN_KEY" \
            --tmdb-key "$TMDB_KEY" \
            --type "$TARGET_TYPE" \
            --telegram-token "$TELEGRAM_TOKEN" \
            --telegram-chat-id "$TELEGRAM_CHAT_ID" \
            --fcm-key "$FCM_KEY" \
            --cache-file "gdids_cache.json" \
            $AUTH_ARGS
            
        else
          # --- SCHEDULED TRIGGER (Sequential) ---
          echo ">>> [SCHEDULE] Starting Sequential Scan..."
          
          # 1. Movie Scan
          echo ">>> [1/2] Scanning Movies..."
          python cloudflare-backend/admin_tools/import_gdindex.py \
            --url "https://drive4.nfgplusmirror.workers.dev/1:/Movie/" \
            --admin-key "$ADMIN_KEY" \
            --tmdb-key "$TMDB_KEY" \
            --type movie \
            --telegram-token "$TELEGRAM_TOKEN" \
            --telegram-chat-id "$TELEGRAM_CHAT_ID" \
            --fcm-key "$FCM_KEY" \
            --cache-file "gdids_cache.json" \
            $AUTH_ARGS

          # 2. TV Series Scan
          echo ">>> [2/2] Scanning TV Series..."
          python cloudflare-backend/admin_tools/import_gdindex.py \
            --url "https://drive4.nfgplusmirror.workers.dev/1:/Series/" \
            --admin-key "$ADMIN_KEY" \
            --tmdb-key "$TMDB_KEY" \
            --type tv \
            --telegram-token "$TELEGRAM_TOKEN" \
            --telegram-chat-id "$TELEGRAM_CHAT_ID" \
            --fcm-key "$FCM_KEY" \
            --cache-file "gdids_cache.json" \
            $AUTH_ARGS
            
          echo ">>> Sequential Scan Completed!"
        fi
